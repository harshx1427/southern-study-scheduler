<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Message</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='message_styles.css') }}">
</head>

<body>
  {% if current_user.is_authenticated %}
    <div class="user-area">
      <a href="{{ url_for('main.profile') }}" class="user-info">
        <div class="user-avatar">
          {{ current_user.name[0]|upper }}
        </div>
        <span>{{ current_user.name }}</span>
      </a>
      <form method="GET" action="{{ url_for('auth.logout') }}">
        <button class="logout-button" type="submit">Log Out</button>
      </form>
    </div>
  {% endif %}

<div class="menu">

    <a href="{{ url_for('main.dashboard') }}"><button class="menu-btn"> Home </button></a>
    <a href="{{ url_for('main.profile') }}"><button class="menu-btn"> Profile </button></a>
    <a href="{{ url_for('main.view_my_groups') }}"><button class="menu-btn"> Groups </button></a>
    <a href="{{ url_for('auth.message') }}"><button class="menu-btn">
      Messages
      {% if unread_count > 0 %}
        <span style="color: red; font-weight: bold;">({{ unread_count }})</span>
      {% endif %}
    </button>
  </a>
</div>

  <h1>Message Board</h1>

<div class="flex-container">

  <!-- Left box: Recent Conversations + Search -->
  <div class="flex-box">
      <h3>Recent Conversations</h3>
      <ul>
        {% for user, unread in recent_contacts %}
          <li>
            <a href="{{ url_for('auth.message_user', user_id=user.id) }}">
              <button class="card-btn">
                {{ user.name }}
                {% if unread > 0 %}<span class="notif-dot"></span>{% endif %}
              </button>
            </a>
          </li>
        {% else %}
          <li>No recent conversations</li>
        {% endfor %}
      </ul>

    <!-- Search bar goes inside left box -->
    <form method="GET" action="{{ url_for('auth.message') }}">
        <input
          type="text"
          id="user-search"
          placeholder="Search users..."
          autocomplete="off">
        <button type="submit" class="card-btn">Search</button>
      </form>
      <div id="suggestions"></div>
    </div>

  <!-- Right box: Sent messages -->
  <div class="flex-box">
    <h3>Your Sent Messages</h3>
    <ul>
      {% for msg in messages %}
        <li>
          To {{ msg.receiver.name }}: {{ msg.content }} <em>({{ msg.posted_at.strftime('%Y-%m-%d %H:%M') }})</em>
        </li>
      {% endfor %}
    </ul>
  </div>

</div>

  <script>
    const input = document.getElementById("user-search");
    const suggestionsBox = document.getElementById("suggestions");
    input.addEventListener("input", async () => {
      const query = input.value.trim();
      if (query.length < 2) {
        suggestionsBox.style.display = "none";
        return;
      }
      const res = await fetch(`/api/user_suggestions?q=${query}`);
      const users = await res.json();
      if (users.length === 0) {
        suggestionsBox.innerHTML = "<p>No matches</p>";
        suggestionsBox.style.display = "block";
        return;
      }
      suggestionsBox.innerHTML = "";
      users.forEach(user => {
        const div = document.createElement("div");
        div.innerHTML = `${user.name} (${user.email})`;
        div.style.cursor = "pointer";
        div.onclick = () => {
          window.location.href = `/message/${user.id}`;
        };
        suggestionsBox.appendChild(div);
      });
      suggestionsBox.style.display = "block";
    });

  </script>

</body>
</html>
